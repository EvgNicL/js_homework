<!-- Урок 3. Сетевые запросы

Цель: Разработать веб-приложение, которое каждый день будет отображать новое случайное изображение из коллекции Unsplash, давая пользователю возможность узнать больше о фотографе и сделать "лайк" изображению.

Регистрация на Unsplash:

• Перейдите на веб-сайт Unsplash (https://unsplash.com/).
• Зарегистрируйтесь или войдите в свой аккаунт. (если у вас не было регистрации до этого, новый аккаунт создавать не нужно).

Создание приложения:

• Перейдите на страницу разработчика Unsplash (https://unsplash.com/developers).
• Нажмите "New Application".
• Заполните необходимую информацию о приложении (можете использовать http://localhost для тестирования).
• Получите свой API-ключ после создания приложения.

Разработка веб-приложения:

• Создайте HTML-страницу с элементами: изображение, имя фотографа, кнопка "лайк" и счетчик лайков.
• Используя JavaScript и ваш API-ключ, получите случайное изображение из Unsplash каждый раз, когда пользователь загружает страницу.
• Отобразите информацию о фотографе под изображением.
• Реализуйте функционал "лайка". Каждый раз, когда пользователь нажимает кнопку "лайк", счетчик должен увеличиваться на единицу.

* Дополнительные задачи (по желанию):

• Добавьте функцию сохранения количества лайков в локальное хранилище, чтобы при новой загрузке страницы счетчик не сбрасывался.
• Реализуйте возможность просмотра предыдущих "фото дня" с сохранением их в истории просмотров. -->
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Document</title>
        <style>
      .main {
        width: 400px;
        background-color: #f5eeee;
        margin: 30px auto 0 auto;
        align-items: center;
      }
      .likes-box {
        margin: 0px 20px 10px 20px;
        display: flex;
        flex-direction: column;
        align-items: end;
      }
      .container-img {
        padding: 10px;
      }
      .container-img img {
        width: 100%;
      }
      .icon {
        transition: all 0.3s;
        animation-name: puls;
        animation-duration: 1s;
        animation-iteration-count: infinite;
      }
      .icon:hover {
        transform: scale(1.2);
      }
      @keyframes puls {
        from {
          width: 35px;
        }
        to {
          transform: scale(1.2);
        }
      }
      .button-box {
        display: flex;
        justify-content: center;
        gap: 30px;
      }
        </style>
    </head>
    <body>
        <main class="main">
          <div class="button-box">
            <button class="left" id="left">&lt</button>
            <button class="right" id="right">&gt</button>
          </div>
        </main>

        <script>
      "use strict";
        
    const main = document.querySelector(".main");
      const currentDate = new Date();
      let startNumberDate = 244;    
      
      // Вычислить номер текущего дня
      function numberOfCurrentDate (date) {
        const num = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
        return num;
    };
    
      // Получить индекс изображения на текущий день
      function getIndexPhoto () {
        const currentNum = numberOfCurrentDate(currentDate);
        if (currentNum === 365) startNumberDate = 1;
        return currentNum - startNumberDate;
    }
      // Загрузка данных с Unsplash
      async function fetchPhotos() {
        try {
          const response = await fetch(
            `https://api.unsplash.com/photos?per_page=8&client_id=-xPKtySGMmki6q2HJfpw9SRuzq5ZNyqwSGcwpaXNH_4`
          );
          const photos = await response.json();
          return photos;
        } catch (error) {
          console.log("Ошибка при загрузке фотографий: ", error);
          return [];
        }
      }

      // Загрузка данных в HTML
      function insertHTML(photo) {
        main.insertAdjacentHTML(
          "afterbegin",
          ` <div>
          <div class="container-img">
                <img class="img" src="${
                  photo.urls.small
                }" alt="photo">
                <h4>${photo.alt_description}</h4>
                <p>${photo.created_at.slice(0, 7)}</p>
            </div>
            <div class="likes-box">
                <img src="/part6_browsersAPI/hw3_Unsplash/finger_top_icon.png" alt="icon" width="35px">
                <p class="count-likes">Количество лайков: ${photo.likes}</p>
            </div>
            </div>
           `);
      }

      // Загрузка фото дня по порядку
      async function loadNextPhoto(index) {
        const photos = await fetchPhotos();
        if (photos.length > 0) {
            index = index % photos.length;
            insertHTML(photos[index]);
            addToHistory(photos[index]);
        };
        return photos;
        };
    
      // Загрузка рандомного фото дня
      async function loadRandomPhoto() {
            const photos = await fetchPhotos();
            if (photos.length > 0) {
                if (startNumberDate < numberOfCurrentDate(currentDate)) {
                    const index = Math.floor(Math.random() * photos.length);
                    insertHTML(photos[index]);
                    addToHistory(photos[index]);
                } else  insertHTML(photos[0]);
            };
            startNumberDate = numberOfCurrentDate(currentDate);
            return photos;

        };
    
      // Записать данные в историю
      function addToHistory (photo) {
        let history = getHistory();
      history.push({
        url: photo.urls.small,
        likes: photo.likes
      });
      localStorage.setItem("photoHistory", JSON.stringify(history));
    };

      // Изменить количество лайков в истории
      function changeHistory (url, likes) {                  
        let history = getHistory();
        history.forEach(element => {
          if (element.url === url) {
            element.likes = likes;
          }
          localStorage.setItem("photoHistory", JSON.stringify(history));
        });
    }

      // Получить историю
      function getHistory () {
        if (localStorage.getItem("photoHistory")) {
          const history = JSON.parse(localStorage.getItem("photoHistory"));
          return history;
        } else return [];
      };
      




      
      
      // установить/снять атрибут disabled на кнопке переключения
      function toggleButtonsAttribute (currentIndex) {
        const length = history.length;
        switch (currentIndex) {
          case 0:
            left.setAttribute('disabled', '');
            break;
          case 1:
            left.removeAttribute('disabled', '');
            break;
          case length - 1:
            right.setAttribute('disabled', '');
            break;
          case length - 2:
            right.removeAttribute('disabled', '');
            break;
          default:
            console.log('ошибочка');
            break;
        }
      };

    //
      function handleLeftClick(currentIndex) {
        let index = currentIndex - 1;
        if (index < 0) {
            index = history.length - 1;
        };
        insertHTML(photos[index]);
      };

    //   
      function handleRightClick(currentIndex) {
        let index = currentIndex + 1;
        if (index >= history.length) {
            index = 0;
        };
        insertHTML(photos[index]);
      };
    //
      function getCurrentHistoryIndex (history) {
        const urlCurrentPhoto = document.querySelector('.img').src;
        history.forEach(el => {
          if (el.url === urlCurrentPhoto) {
            if (history.indexOf(el) !== -1) {
              console.log(history.indexOf(el));
              return history.indexOf(el);
            } else return console.log('Ошибочка');
          };
        });
      };




    //const photos =  loadNextPhoto(getIndexPhoto());
    const photos =  loadRandomPhoto();
    console.log(photos);


    main.addEventListener('click', function (e) {
      let history = getHistory();
      const icon = e.target.classList.contains('click');
      let likes =document.querySelector('.count-likes');
      const url = document.querySelector('.img').src;
      const currentIndex = getCurrentHistoryIndex(history);
      let count = 0;
     
      // toggleButtonsAttribute(currentIndex);
      if (icon) {
        const count = +likes.textContent.split(': ')[1] + 1;
        likes.innerHTML = likes.textContent.split(': ')[0] + ': ' + count;
        changeHistory(url, count);
        document.querySelector('.icon').classList.remove('click');
      };
      if (e.target.classList.contains('left')) {
        handleLeftClick(currentIndex);
      };

      // if (e.target.classList.contains('right')) {
      //   handleRightClick();
      // };
    });


        </script>
    </body>
</html>
